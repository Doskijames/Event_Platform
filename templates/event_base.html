{# templates/event_base.html #}
{% extends "base.html" %}
{% block content %}

<div class="event-shell{% if public_single %} public-single-shell public-single{% endif %}">

  {# ===== Public single-page topbar ===== #}
  {% if public_single %}
    <div class="event-public-topbar"
         style="position:fixed;left:0;right:0;top:0;height:var(--navH);display:flex;align-items:center;gap:12px;padding:0 16px;z-index:50;background:var(--topbarBg);backdrop-filter: blur(8px);">
      <div class="event-public-title" style="font-weight:600;letter-spacing:.2px;">
        {{ event.name }}
      </div>
    </div>
  {% endif %}

  {# ===== Admin/owner editor chrome (NOT public single) ===== #}
  {% if not public_single %}
    <div class="event-titlebar">
      <h1>{{ event.name }}</h1>

      <div class="titlebar-actions" style="display:flex;gap:10px;flex-wrap:wrap;">
        <a class="btn btn-outline" href="{{ url_for('events') }}">All Events</a>
        <a class="btn btn-outline" href="{{ url_for('event_logout', slug=event.slug) }}">Lock Event</a>

        {% if can_manage and request.args.get('_as_user') != '1' %}
          <a class="btn btn-outline" target="_blank"
             href="{{ url_for('event_section', slug=event.slug, section_key=section_key, _as_user=1, _draft=1) }}">
            Open Public Preview
          </a>
        {% endif %}
        {% if can_manage and request.args.get('_as_user') == '1' %}
          <a class="btn btn-outline"
             href="{{ url_for('event_section', slug=event.slug, section_key=section_key) }}">
            Back to Editor
          </a>
        {% endif %}

        {% if is_admin %}
          <a class="btn btn-outline" href="{{ url_for('rsvp_responses_view', slug=event.slug) }}">RSVP Responses</a>
          <a class="btn btn-outline" href="{{ url_for('add_section', slug=event.slug) }}">Add Section</a>
        {% endif %}
      </div>
    </div>

    <div class="event-nav" id="eventNav">
      {% for key, s in sections.items() %}
        {% if s.visible or is_admin %}
          {% if key == "rsvp" %}
            <a class="event-navlink {% if section_key == 'rsvp' %}active{% endif %}"
               href="{{ url_for('rsvp_form', slug=event.slug) }}"
               data-key="{{ key }}"
               {% if is_admin %}draggable="true"{% endif %}>
              {% if is_admin %}<span class="drag-handle">↕</span>{% endif %}
              {{ s.title }}
            </a>
          {% else %}
            <a class="event-navlink {% if key == section_key %}active{% endif %}"
               href="{{ url_for('event_section', slug=event.slug, section_key=key) }}"
               data-key="{{ key }}"
               {% if is_admin %}draggable="true"{% endif %}>
              {% if is_admin %}<span class="drag-handle">↕</span>{% endif %}
              {{ s.title }}
            </a>
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  <div class="event-content">
    {% block event_content %}{% endblock %}
  </div>

</div>

{% if is_admin %}
<script>
(function(){
  const nav = document.getElementById("eventNav");
  if(!nav) return;

  let dragging = null;

  nav.querySelectorAll("[draggable='true']").forEach(el => {
    el.addEventListener("dragstart", (e) => {
      dragging = el;
      e.dataTransfer.effectAllowed = "move";
      el.classList.add("dragging");
    });

    el.addEventListener("dragend", () => {
      if(dragging) dragging.classList.remove("dragging");
      dragging = null;
      saveOrder();
    });

    el.addEventListener("dragover", (e) => {
      e.preventDefault();
      const target = el;
      if(!dragging || dragging === target) return;

      const rect = target.getBoundingClientRect();
      const after = (e.clientY - rect.top) > (rect.height/2);
      if(after){
        target.after(dragging);
      } else {
        target.before(dragging);
      }
    });
  });

  async function saveOrder(){
    const order = Array.from(nav.querySelectorAll("[data-key]")).map(a => a.dataset.key);
    try{
      await fetch(`/events/{{ event.slug }}/sections/reorder`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({order})
      });
    }catch(e){}
  }
})();
</script>

<style>
.drag-handle{opacity:.55;margin-right:8px;cursor:grab;}
.event-navlink.dragging{opacity:.5;}
</style>
{% endif %}

{% endblock %}
