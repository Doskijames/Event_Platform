{% extends "base.html" %}
{% from "_media.html" import media_url %}

{% block content %}
<div class="page-wrap">

  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div>
      <h1 style="margin:0;">Events</h1>
      <p class="muted" style="margin:6px 0 0;">Browse events and open your website pages.</p>
    </div>

    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      {% if user %}
        <div class="muted" style="font-weight:800;">{{ user.email }}</div>
      {% endif %}
      {% if has_endpoint('create_event') %}
        <a class="btn" href="{{ url_for('create_event') }}">Create Event</a>
      {% endif %}
    </div>
  </div>

  {% if not events or events|length == 0 %}
    <div class="section-card" style="margin-top:16px;">
      <div class="muted" style="font-weight:900;">No events yet.</div>
      {% if has_endpoint('create_event') %}
        <p style="margin:10px 0 0;"><a href="{{ url_for('create_event') }}">Create your first event</a></p>
      {% endif %}
    </div>
  {% else %}
    <div style="margin-top:16px; display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px;">
      {% for event in events %}
        {% set can_delete = (user and ((user.role|lower == 'admin') or ((event.owner_user_id|default(0)|int) == (user.id|default(0)|int)))) %}
        <div class="section-card" style="padding:0; overflow:hidden; display:flex; flex-direction:column;">
          <div style="background:#0b0b0b;">
            {% if event.cover_image %}
              <img src="{{ media_url(event.cover_image) }}" alt="Event hero image"
                   style="width:100%; height:180px; object-fit:contain; object-position:center; background:#0b0b0b; display:block;">
            {% else %}
              <div style="height:180px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:900;">
                No cover image
              </div>
            {% endif %}
          </div>

          <div style="padding:14px; display:flex; flex-direction:column; gap:10px; flex:1;">
            <div>
              <div style="font-weight:1000; font-size:1.05rem; color:var(--accent); line-height:1.2;">
                {{ event.name }}
              </div>
              <div class="muted" style="margin-top:6px;">
                {{ event.date_iso }} Â· {{ event.location }}
              </div>
            </div>

            <div style="margin-top:auto; display:flex; gap:10px; flex-wrap:wrap;">
              {% if has_endpoint('event_gate') %}
                <a class="btn btn-outline" href="{{ url_for('event_gate', slug=event.slug) }}">Open</a>
              {% elif has_endpoint('event_section') %}
                <a class="btn btn-outline" href="{{ url_for('event_section', slug=event.slug, section_key='home') }}">Open</a>
              {% else %}
                <span class="muted">No event route found</span>
              {% endif %}

              {% if can_delete and has_endpoint('delete_event') %}
                <form method="POST" action="{{ url_for('delete_event', slug=event.slug) }}"
                      onsubmit="return confirm('Delete this event permanently? This cannot be undone.');"
                      style="margin:0;">
                  <button class="btn btn-outline" type="submit" style="border-color:#b00020; color:#b00020;">
                    Delete
                  </button>
                </form>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock %}
