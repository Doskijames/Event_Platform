{% extends "base.html" %}
{% from "_media.html" import media_url %}
{% block content %}

<div class="container">
  <div class="page-head">
    <h1>Events</h1>
    <p class="muted">Browse available events. Log in and enter the passcode to access an event.</p>

    {% if user %}
      <div class="actions-row">
        <a class="btn" href="{{ url_for('create_event') }}">+ Create Event</a>
      </div>
    {% endif %}
  </div>

  <div class="events-grid">

    {% if user %}
      <a class="event-card create-card" href="{{ url_for('create_event') }}">
        <div class="event-cover create-cover">
          <div class="create-plus">+</div>
        </div>
        <div class="event-card-body">
          <div class="event-card-header">
            <h3 class="event-title">Create a New Event</h3>
            <span class="event-pill">NEW</span>
          </div>
          <div class="event-meta">
            <span class="muted">Start your own event container</span>
          </div>
          <div class="event-cta">Click to create →</div>
        </div>
      </a>
    {% endif %}

    {% for e in events %}
      {# Can delete if admin OR owner #}
      {% set is_admin = (user and (user.role|default('')|lower == 'admin')) %}
      {% set is_owner = (user and (e.owner_user_id|default(None) == user.id|default(None))) %}
      {% set can_delete = (is_admin or is_owner) %}

      <div style="position:relative;">
        {% if can_delete %}
          <form
            method="POST"
            action="{{ url_for('delete_event', slug=e.slug) }}"
            style="position:absolute; top:12px; right:12px; z-index:5; margin:0;"
            onsubmit="return confirm('Delete this event permanently? This cannot be undone.');"
          >
            <button
              type="submit"
              class="btn btn-outline"
              style="padding:8px 10px; font-size:0.9rem; line-height:1; border-radius:12px;"
              title="Delete event"
            >
              Delete
            </button>
          </form>
        {% endif %}

        <a class="event-card" href="{{ url_for('event_gate', slug=e.slug) }}">
          <div class="event-cover">
            {% if e.cover_image %}
              <img src="{{ media_url(e['cover_image']) }}" alt="Event hero image">
            {% else %}
              <div class="event-cover-placeholder">No Cover Photo</div>
            {% endif %}
          </div>

          <div class="event-card-body">
            <div class="event-card-header">
              <h3 class="event-title">{{ e.name }}</h3>
              <span class="event-pill">LOCKED</span>
            </div>

            <div class="event-meta">
              <span>{{ e.date_iso }}</span>
              <span class="dot">•</span>
              <span>{{ e.location }}</span>
            </div>

            <div class="event-description muted">
              {{ e.description }}
            </div>

            <div class="event-cta">Open event →</div>
          </div>
        </a>
      </div>
    {% endfor %}

  </div>
</div>

{% endblock %}
