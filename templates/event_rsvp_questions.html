{% extends "event_base.html" %}
{% block event_content %}

<div class="section-card">
  <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div>
      <h2 class="accent" style="margin:0;">RSVP Questions</h2>
      <p class="muted" style="margin:6px 0 0;">
        Build your RSVP form. Follow-up questions appear based on earlier answers.
      </p>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" type="button" id="saveBtn">Save</button>
      <a class="btn btn-outline" href="{{ url_for('rsvp_form', slug=event.slug) }}">Preview Form</a>
    </div>
  </div>

  <p class="muted" id="saveStatus" style="margin:12px 2px 0; font-weight:900;"></p>

  <div id="qList" style="margin-top:16px; display:grid; gap:16px;"></div>

  <div class="actions-row" style="margin-top:18px;">
    <button class="btn btn-outline" type="button" id="addQ">+ Add Question</button>
  </div>

  <div class="admin-box" style="margin-top:16px;">
    <form method="POST" action="{{ url_for('toggle_section', slug=event.slug, section_key='rsvp') }}">
      <button class="btn btn-outline" type="submit">
        {% if section.visible %}Hide RSVP{% else %}Show RSVP{% endif %}
      </button>
    </form>
  </div>
</div>

<style>
  /* Make typing stable and prevent “jump” feeling */
  textarea.rsvp-qtext {
    min-height: 96px;
    resize: vertical;
    line-height: 1.35;
  }
  .rsvp-row { display:flex; gap:8px; align-items:center; }
  .rsvp-row .input { flex: 1; }
</style>

<script>
(function(){
  const EVENT_SLUG = "{{ event.slug }}";
  const DRAFT_KEY = `rsvp_questions_draft::${EVENT_SLUG}`;

  const serverInitial = {{ (questions or [])|tojson }};

  function setStatus(msg){
    const el = document.getElementById("saveStatus");
    el.textContent = msg || "";
  }

  function esc(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function normalizeFromServer(rows){
    const arr = Array.isArray(rows) ? rows : [];
    return arr.map(q => ({
      question: q.question || "",
      type: q.type || "text",
      options: Array.isArray(q.options) ? q.options.slice() : [],
      required: !!q.required,
      show_if_question: (q.show_if_question == null ? "" : String(q.show_if_question)),
      show_if_value: q.show_if_value || "",
      is_followup: !!q.show_if_question,
      multi: !!q.multi,
    }));
  }

  function loadDraftOrServer(){
    try{
      const raw = localStorage.getItem(DRAFT_KEY);
      if (raw){
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) return parsed;
      }
    }catch(e){}
    return normalizeFromServer(serverInitial);
  }

  let state = loadDraftOrServer();

  if (!state.length){
    state.push({
      question:"Will you be attending?",
      type:"choice",
      options:["Yes","No"],
      required:true,
      is_followup:false,
      show_if_question:"",
      show_if_value:"",
      multi:false
    });
  }

  function persistDraft(){
    try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(state)); }catch(e){}
  }

  function getParentOptions(idx){
    return state.slice(0, idx).map((q, i) => ({
      value: String(i + 1),
      label: `Q${i+1}: ${q.question || "(Untitled question)"}`
    }));
  }

  function refreshAllFollowupSelects(){
    document.querySelectorAll("[data-showqsel]").forEach(sel => {
      const idx = Number(sel.dataset.showqsel);
      const prev = (state[idx] && state[idx].show_if_question) ? String(state[idx].show_if_question) : "";

      const opts = getParentOptions(idx);
      if (!opts.length){
        sel.innerHTML = `<option value="">Add a main question first</option>`;
        sel.disabled = true;
        return;
      }

      sel.disabled = false;
      sel.innerHTML =
        `<option value="">Select question…</option>` +
        opts.map(o =>
          `<option value="${esc(o.value)}" ${o.value===prev ? "selected" : ""}>${esc(o.label)}</option>`
        ).join("");
    });
  }

  const list = document.getElementById("qList");

  function render(){
    list.innerHTML = "";

    state.forEach((q, idx) => {
      const wrap = document.createElement("div");
      wrap.className = "admin-box";
      wrap.style.margin = "0";

      const isChoice = q.type === "choice";

      wrap.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div class="muted" style="font-weight:900;">Question ${idx+1}</div>
          <button class="btn btn-outline" type="button" data-del="${idx}">Remove</button>
        </div>

        <div style="margin-top:12px;">
          <label class="label">Question text</label>
          <textarea class="input textarea rsvp-qtext" rows="4" data-question="${idx}"
            placeholder="Type your question here...">${esc(q.question)}</textarea>

          <div style="margin-top:10px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div>
              <label class="label">Question type</label>
              <select class="input" data-type="${idx}">
                <option value="text" ${q.type==="text"?"selected":""}>Text</option>
                <option value="choice" ${q.type==="choice"?"selected":""}>Multiple choice</option>
                <option value="number" ${q.type==="number"?"selected":""}>Number</option>
              </select>
            </div>

            <div>
              <label class="label">Required</label>
              <select class="input" data-required="${idx}">
                <option value="1" ${q.required?"selected":""}>Yes</option>
                <option value="0" ${!q.required?"selected":""}>No</option>
              </select>
            </div>
          </div>

          ${isChoice ? `
            <div style="margin-top:10px;">
              <label class="label">Allow multiple selections?</label>
              <select class="input" data-multi="${idx}">
                <option value="0" ${!q.multi?"selected":""}>One option</option>
                <option value="1" ${q.multi?"selected":""}>Multiple options</option>
              </select>
            </div>

            <div style="margin-top:10px;">
              <label class="label">Options</label>
              <div data-opts="${idx}" style="display:grid; gap:8px;"></div>
              <button class="btn btn-outline" data-addopt="${idx}" type="button" style="margin-top:8px;">+ Add option</button>
            </div>
          ` : ``}

          <div style="margin-top:12px;">
            <label class="label">Question role</label>
            <select class="input" data-role="${idx}">
              <option value="main" ${!q.is_followup?"selected":""}>Main question</option>
              <option value="follow" ${q.is_followup?"selected":""}>Follow-up question</option>
            </select>
          </div>

          <div style="margin-top:10px; display:${q.is_followup ? "block" : "none"};" data-follow="${idx}">
            <label class="label">Show only if answer to</label>
            <select class="input" data-showqsel="${idx}"></select>

            <label class="label" style="margin-top:8px;">Equals</label>
            <input class="input" data-showv="${idx}" value="${esc(q.show_if_value)}"
              placeholder="Yes or Yes|Maybe">
            <p class="muted" style="margin:8px 2px 0; font-size:.9rem;">
              Use <strong>|</strong> for multiple values (example: <strong>Yes|Maybe</strong>).
            </p>
          </div>
        </div>
      `;

      list.appendChild(wrap);

      // typing: NO re-render
      wrap.querySelector(`[data-question="${idx}"]`).addEventListener("input", e=>{
        q.question = e.target.value;
        persistDraft();
        refreshAllFollowupSelects(); // only updates dropdown labels, no full re-render
      });

      wrap.querySelector(`[data-type="${idx}"]`).addEventListener("change", e=>{
        q.type = e.target.value;
        if (q.type !== "choice"){
          q.options = [];
          q.multi = false;
        } else {
          if (!Array.isArray(q.options) || !q.options.length) q.options = ["Yes","No"];
        }
        persistDraft();
        render();
      });

      wrap.querySelector(`[data-required="${idx}"]`).addEventListener("change", e=>{
        q.required = e.target.value === "1";
        persistDraft();
      });

      wrap.querySelector(`[data-role="${idx}"]`).addEventListener("change", e=>{
        q.is_followup = e.target.value === "follow";
        if (!q.is_followup){
          q.show_if_question = "";
          q.show_if_value = "";
        }
        persistDraft();
        render();
      });

      const showSel = wrap.querySelector(`[data-showqsel="${idx}"]`);
      if (showSel){
        showSel.addEventListener("change", e=>{
          q.show_if_question = e.target.value;
          persistDraft();
        });
      }

      const showVal = wrap.querySelector(`[data-showv="${idx}"]`);
      if (showVal){
        showVal.addEventListener("input", e=>{
          q.show_if_value = e.target.value;
          persistDraft();
        });
      }

      wrap.querySelector(`[data-del="${idx}"]`).addEventListener("click", ()=>{
        state.splice(idx,1);
        persistDraft();
        render();
      });

      if (q.type === "choice"){
        const box = wrap.querySelector(`[data-opts="${idx}"]`);
        if (!Array.isArray(q.options) || !q.options.length) q.options = ["Yes","No"];

        q.options.forEach((opt, j)=>{
          const row = document.createElement("div");
          row.className = "rsvp-row";
          row.innerHTML = `
            <input class="input" style="flex:1" value="${esc(opt)}">
            <button class="btn btn-outline" type="button" aria-label="Remove option">✕</button>
          `;
          row.querySelector("input").addEventListener("input", e=>{
            q.options[j] = e.target.value;
            persistDraft();
          });
          row.querySelector("button").addEventListener("click", ()=>{
            q.options.splice(j,1);
            persistDraft();
            render();
          });
          box.appendChild(row);
        });

        wrap.querySelector(`[data-addopt="${idx}"]`).addEventListener("click", ()=>{
          q.options.push("");
          persistDraft();
          render();
        });

        const multiSel = wrap.querySelector(`[data-multi="${idx}"]`);
        if (multiSel){
          multiSel.addEventListener("change", e=>{
            q.multi = e.target.value === "1";
            persistDraft();
          });
        }
      }
    });

    refreshAllFollowupSelects();
  }

  async function save(){
    try{
      setStatus("Saving...");

      const payload = state.map((q,i)=>({
        position: i+1,
        question: (q.question || "").trim(),
        type: q.type || "text",
        options: (q.type==="choice") ? (q.options || []).map(x=>String(x||"").trim()).filter(Boolean) : [],
        required: !!q.required,
        show_if_question: q.is_followup ? (q.show_if_question || "") : "",
        show_if_value: q.is_followup ? (q.show_if_value || "").trim() : "",
        multi: (q.type==="choice") ? !!q.multi : false
      })).filter(x=>x.question);

      const res = await fetch("{{ url_for('rsvp_questions_save', slug=event.slug) }}",{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:new URLSearchParams({questions_json: JSON.stringify(payload)}).toString()
      });

      if (!res.ok){
        setStatus("Save failed. Please try again.");
        return;
      }

      // clear draft only after successful save
      try{ localStorage.removeItem(DRAFT_KEY); }catch(e){}

      setStatus("Saved ✅");
      setTimeout(()=>setStatus(""),1800);

    }catch(e){
      setStatus("Save failed. Please try again.");
    }
  }

  document.getElementById("addQ").addEventListener("click", ()=>{
    state.push({
      question:"",
      type:"text",
      options:[],
      required:true,
      is_followup:false,
      show_if_question:"",
      show_if_value:"",
      multi:false
    });
    persistDraft();
    render();
  });

  document.getElementById("saveBtn").addEventListener("click", save);

  render();
})();
</script>

{% endblock %}
