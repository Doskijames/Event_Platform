{% extends "event_base.html" %}
{% from "_media.html" import media_url %}
{% block event_content %}
<div class="container">
  <div class="card">
    <div class="card-header">
      <div>
        <h2>Photos</h2>
        <p class="muted">A slideshow gallery. Admin/event creator can upload photos and optional background music.</p>
      </div>
    </div>

    <div class="card-body">
      {% if is_admin %}
      <div class="grid-2" style="margin-bottom:16px;">
        <div class="card" style="padding:14px;">
          <h3 style="margin-top:0;">Upload photos</h3>
          <form method="POST" enctype="multipart/form-data" action="{{ url_for('event_photos', slug=event.slug) }}">
            <input class="input" type="file" name="photos" accept="image/*" multiple required>
            <div style="margin-top:10px;">
              <button class="btn btn-primary" type="submit">Upload</button>
            </div>
          </form>
        </div>

        <div class="card" style="padding:14px;">
          <h3 style="margin-top:0;">Upload music</h3>
          <form method="POST" enctype="multipart/form-data" action="{{ url_for('photos_music_upload', slug=event.slug) }}">
            <input class="input" type="file" name="music" accept="audio/*" required>
            <div style="margin-top:10px;">
              <button class="btn" type="submit">Upload music</button>
            </div>
            <p class="muted" style="margin-top:8px;">Note: some browsers block autoplay until the user clicks play.</p>
          </form>
        </div>
      </div>
      {% endif %}

      {% if music_file %}
        <div class="card" style="padding:14px;margin-bottom:16px;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
            <div><strong>Background music</strong></div>
            <audio id="bgAudio" controls loop preload="metadata" style="width:min(520px,100%);">
              <source src="{{ media_url(music_file) }}">
            </audio>
          </div>
          <p class="muted" style="margin:8px 0 0;">If it doesn’t auto-play, press play once.</p>
        </div>
      {% endif %}

      {% if photos and photos|length > 0 %}
        <div class="slideshow card" style="padding:14px;margin-bottom:14px;">
          <div class="slide-wrap">
            {% for p in photos %}
              <img class="slide {% if loop.first %}active{% endif %}"
                   src="{{ media_url(p.file_name) }}"
                   alt="Photo {{ loop.index }}">
            {% endfor %}
          </div>

          <div class="slide-controls">
            <button class="btn" type="button" id="btnPrev">Prev</button>
            <div class="muted" id="slideCount"></div>
            <button class="btn" type="button" id="btnNext">Next</button>
          </div>
        </div>

        <div class="grid">
          {% for p in photos %}
            <button class="thumb" type="button" data-idx="{{ loop.index0 }}">
              <img src="{{ media_url(p.file_name) }}" alt="thumb {{ loop.index }}">
            </button>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No photos uploaded yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function(){
  const slides = Array.from(document.querySelectorAll('.slide'));
  if(!slides.length) return;

  const countEl = document.getElementById('slideCount');
  const prevBtn = document.getElementById('btnPrev');
  const nextBtn = document.getElementById('btnNext');
  const thumbs = Array.from(document.querySelectorAll('.thumb'));

  let idx = 0;

  function show(i){
    idx = (i + slides.length) % slides.length;
    slides.forEach((s, k) => s.classList.toggle('active', k === idx));
    if(countEl) countEl.textContent = (idx+1) + " / " + slides.length;
  }

  if(prevBtn) prevBtn.addEventListener('click', () => show(idx-1));
  if(nextBtn) nextBtn.addEventListener('click', () => show(idx+1));
  thumbs.forEach(t => t.addEventListener('click', () => show(parseInt(t.dataset.idx, 10))));

  setInterval(() => show(idx+1), 5000);
  show(0);

  const audio = document.getElementById('bgAudio');
  if(audio){
    const tryPlay = () => { audio.play().catch(()=>{}); window.removeEventListener('click', tryPlay); };
    window.addEventListener('click', tryPlay);
  }
})();
</script>

<style>
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media(max-width:900px){.grid-2{grid-template-columns:1fr;}}
.slide-wrap{
  position:relative;
  overflow:hidden;
  border-radius:16px;
  aspect-ratio:16/9;
  background:#000;
}
.slide{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain; /* ✅ show whole image */
  opacity:0;
  transition:opacity .4s ease;
  background:rgba(0,0,0,.15);
}
.slide.active{opacity:1;}
.slide-controls{display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:10px;}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;}
.thumb{border:0;background:rgba(0,0,0,.15);padding:0;cursor:pointer;}
.thumb img{width:100%;height:90px;object-fit:contain;border-radius:12px;display:block;}
</style>
{% endblock %}
