{% extends "event_base.html" %}
{% from "_media.html" import media_url %}
{% block event_content %}

<!-- ===== FONTS FOR RICH TEXT EDITOR ===== -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<link href="https://fonts.googleapis.com/css2?
family=Inter:wght@400;600;800&
family=Manrope:wght@400;600;800&
family=Domine:wght@400;600;700&
family=Barlow:wght@400;600;700&
family=Chakra+Petch:wght@400;600;700&
family=Unbounded:wght@400;600;800&
family=Public+Sans:wght@400;600;800&
family=Space+Grotesk:wght@400;600;700&
family=Archivo:wght@400;600;800&
family=EB+Garamond:wght@400;600;700&
family=Caprasimo&
family=Epilogue:wght@400;600;800
&display=swap" rel="stylesheet">

<link href="https://fonts.cdnfonts.com/css/satoshi" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/instrument-serif" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/cabinet-grotesk" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/zodiak" rel="stylesheet">
<link href="https://fonts.cdnfonts.com/css/melodrama" rel="stylesheet">

{% if is_admin %}

<div class="admin-editor-grid">


  <!-- LEFT: Editor -->
  <div class="section-card">

    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div>
        <h2 class="accent" style="margin:0;">{{ qa_title }}</h2>
        <p class="muted" style="margin:6px 0 0;">
          Add questions and answers. Preview updates instantly.
          Guests only see it after you click <strong>Save</strong>.
        </p>
      </div>

      <form method="POST" action="{{ url_for('custom_section_publish', slug=event.slug, section_key=section_key) }}">
        <button class="btn" type="submit">Save</button>
      </form>
    </div>

    <div class="admin-box" style="margin-top:14px;">
      <form method="POST" enctype="multipart/form-data"
            action="{{ url_for('upload_section_image', slug=event.slug, section_key=section_key) }}">
        <div class="admin-row">
          <label class="mini-label">{{ qa_title }} Photo</label>
          <input class="mini-file" type="file" name="image" required>
          <button class="btn mini-btn" type="submit">Upload</button>
        </div>
      </form>
      <p class="muted" style="margin:10px 2px 0; font-weight:900;">
        Uploading again replaces the previous photo.
      </p>
    </div>

    <!-- List editor -->
    <div class="admin-box" style="margin-top:14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div class="mini-label">Items</div>
        <button class="btn btn-outline" type="button" id="addItemBtn">+ Add</button>
      </div>

      <div id="itemsWrap" style="margin-top:12px; display:grid; gap:12px;"></div>

      <input type="hidden" id="draftJsonField" value='{{ qa_draft_items|tojson }}'>
    </div>

    <div class="admin-box" style="margin-top:14px;">
      <form method="POST" action="{{ url_for('toggle_section', slug=event.slug, section_key=section_key) }}">
        <button class="btn btn-outline" type="submit">
          {% if section.visible %}Hide {{ qa_title }}{% else %}Show {{ qa_title }}{% endif %}
        </button>
      </form>
    </div>

    <div class="admin-box" style="margin-top:14px; border:1px solid rgba(255,60,60,.35);">
      <form method="POST" action="{{ url_for('custom_section_delete', slug=event.slug, section_key=section_key) }}"
            onsubmit="return confirm('Delete this section? This cannot be undone.');">
        <button class="btn" type="submit" style="background:rgba(255,60,60,.12); border:1px solid rgba(255,60,60,.5);">
          Delete Section
        </button>
      </form>
      <p class="muted" style="margin:10px 2px 0; font-weight:900;">Deletes this custom section for this event.</p>
    </div>

    <p class="muted" id="autosaveStatus" style="margin:12px 2px 0; font-weight:900;"></p>

  </div>

  <!-- RIGHT: Preview -->
  <div class="section-card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div class="muted" style="font-weight:900;">Preview</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-outline" type="button" id="btnDesk">Desktop</button>
        <button class="btn btn-outline" type="button" id="btnPhone">Phone</button>
      </div>
    </div>

    <div style="margin-top:14px;">
      <div id="previewDesk" style="display:block;">
        <div style="border:1px solid var(--border); border-radius:18px; overflow:hidden; background:rgba(255,255,255,0.02);">
          <div style="display:grid; grid-template-columns: minmax(140px,1fr) minmax(0,4fr); min-height:420px;">

            <div style="background:#0b0b0b; position:relative;">
              {% if section.image %}
                <img src="{{ media_url(section.image) }}"
                     alt="{{ qa_title }} preview"
                     style="width:100%; height:100%; object-fit:cover; display:block;">
              {% else %}
                <div style="height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:900;">
                  Upload {{ qa_title }} Photo
                </div>
              {% endif %}
              <div style="position:absolute; left:14px; bottom:14px; right:14px;">
                <div style="font-weight:900; font-size:1.1rem; color:#fff; text-shadow:0 6px 20px rgba(0,0,0,.7);">
                  {{ event.name }}
                </div>
              </div>
            </div>

            <div style="padding:18px; max-height:420px; overflow:auto;">
              <h3 style="margin:0 0 12px; color:var(--accent);">{{ qa_title }}</h3>
              <div id="previewContentDesk" style="display:grid; gap:12px;"></div>
            </div>

          </div>
        </div>
      </div>

      <div id="previewPhone" style="display:none;">
        <div style="max-width:360px; margin:0 auto; border:1px solid var(--border); border-radius:24px; overflow:hidden;">
          <div style="background:#0b0b0b; position:relative;">
            {% if section.image %}
              <img src="{{ media_url(section.image) }}"
                   alt="{{ qa_title }} phone preview"
                   style="width:100%; height:260px; object-fit:cover; display:block;">
            {% else %}
              <div style="height:260px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:900;">
                Upload {{ qa_title }} Photo
              </div>
            {% endif %}
            <div style="position:absolute; left:14px; bottom:14px; right:14px;">
              <div style="font-weight:900; font-size:1.05rem; color:#fff; text-shadow:0 6px 20px rgba(0,0,0,.7);">
                {{ event.name }}
              </div>
            </div>
          </div>

          <div style="padding:16px; background:rgba(255,255,255,0.02); max-height:420px; overflow:auto;">
            <h3 style="margin:0 0 12px; color:var(--accent);">{{ qa_title }}</h3>
            <div id="previewContentPhone" style="display:grid; gap:12px;"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
(function(){
  const btnDesk = document.getElementById("btnDesk");
  const btnPhone = document.getElementById("btnPhone");
  const prevDeskWrap = document.getElementById("previewDesk");
  const prevPhoneWrap = document.getElementById("previewPhone");

  btnDesk.addEventListener("click", ()=>{
    prevDeskWrap.style.display = "block";
    prevPhoneWrap.style.display = "none";
  });
  btnPhone.addEventListener("click", ()=>{
    prevDeskWrap.style.display = "none";
    prevPhoneWrap.style.display = "block";
  });
})();
</script>

<script type="application/json" id="publishedJson">{{ qa_published_items|tojson }}</script>

<script>
(function(){
  const wrap = document.getElementById("itemsWrap");
  const addBtn = document.getElementById("addItemBtn");
  const statusEl = document.getElementById("autosaveStatus");
  const draftField = document.getElementById("draftJsonField");

  function setStatus(msg){ statusEl.textContent = msg || ""; }

  function safeParse(jsonStr){
    try {
      const v = JSON.parse(jsonStr || "[]");
      return Array.isArray(v) ? v : [];
    } catch(e) {
      return [];
    }
  }

  function normalize(items){
    return (items || []).map(it => {
      if(!it || typeof it !== "object") return { q:"", a:"" };
      const q = (it.q ?? it.question ?? "").toString();
      const a = (it.a ?? it.answer ?? "").toString();
      return { q, a };
    }).filter(it => (it.q.trim() || it.a.trim()));
  }

  let items = normalize(safeParse(draftField.value));
  if (!items.length) {
    const published = normalize(safeParse(document.getElementById("publishedJson").textContent));
    items = published;
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function itemRow(it, idx){
    const row = document.createElement("div");
    row.className = "rsvp-item";
    row.style.background = "rgba(255,255,255,0.02)";
    row.style.borderRadius = "14px";

    row.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
        <div class="mini-label">Item ${idx+1}</div>
        <button type="button" class="btn btn-outline" data-action="remove">Remove</button>
      </div>
      <div style="display:grid; gap:10px; margin-top:10px;">
        <div>
          <div class="label" style="font-size:.9rem;">Question</div>
          <input class="input" type="text" data-field="q" value="${escapeHtml((it.q||"").replace(/^\s*Q:\s*/i,""))}" placeholder="Enter question">
        </div>
        <div>
          <div class="label" style="font-size:.9rem;">Answer</div>
          <textarea class="input textarea joy-autogrow" data-field="a" placeholder="Enter answer" style="width:100%;" rows="6">${escapeHtml((it.a||"").replace(/^\s*A:\s*/i,""))}</textarea>
        </div>
      </div>
    `;

    row.querySelector('[data-action="remove"]').addEventListener("click", ()=>{
      items.splice(idx, 1);
      render();
      scheduleSave();
    });

    row.querySelectorAll("[data-field]").forEach(el => {
      el.addEventListener("input", ()=>{
        const f = el.getAttribute("data-field");
        items[idx][f] = el.value;
        renderPreview();
        scheduleSave();
      });
    });

    return row;
  }

  function render(){
    wrap.innerHTML = "";
    if (!items.length) {
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.style.fontWeight = "900";
      empty.textContent = "No items yet. Click Add to create one.";
      wrap.appendChild(empty);
    } else {
      items.forEach((it, idx) => wrap.appendChild(itemRow(it, idx)));
    }
    renderPreview();
  }

  function renderPreview(){
    const desk = document.getElementById("previewContentDesk");
    const phone = document.getElementById("previewContentPhone");
    const html = items.map(it => `
      <div style="border:1px solid var(--border); border-radius:14px; padding:12px; background:rgba(255,255,255,0.02);">
        <div style="color:var(--accent); font-weight:900;">${escapeHtml((it.q||"").replace(/^\s*Q:\s*/i,""))}</div>
        <div style="margin-top:8px; color:var(--text); line-height:1.6; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word;">${escapeHtml((it.a||"").replace(/^\s*A:\s*/i,""))}</div>
      </div>
    `).join("");

    desk.innerHTML = html || '<div class="muted" style="font-weight:900;">No items yet.</div>';
    phone.innerHTML = html || '<div class="muted" style="font-weight:900;">No items yet.</div>';
  }

  let timer = null;
  let lastSent = "";
  let inflight = false;

  async function sendDraft(jsonStr){
    if (inflight) return;
    inflight = true;
    try {
      setStatus("Saving draft...");
      const resp = await fetch("{{ url_for('custom_section_save_draft', slug=event.slug, section_key=section_key) }}", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ draft_json: jsonStr }).toString()
      });
      setStatus(resp.ok ? "Draft saved." : "Draft save failed.");
    } catch(e) {
      setStatus("Draft save failed.");
    } finally {
      inflight = false;
    }
  }

  function scheduleSave(){
    if (timer) clearTimeout(timer);
    timer = setTimeout(()=>{
      const cleaned = normalize(items);
      const payload = JSON.stringify(cleaned, null, 0);
      if (payload !== lastSent) {
        lastSent = payload;
        draftField.value = payload;
        sendDraft(payload);
      }
    }, 650);
  }

  addBtn.addEventListener("click", ()=>{
    items.push({ q:"", a:"" });
    render();
    scheduleSave();
  });

  render();
  setStatus("");
})();
</script>

{% else %}

<!-- NORMAL USERS: match event_story_editor.html public view -->
{% set hero_img = (section.image or (sections.get('home').image if sections.get('home') else '')) %}

<div class="section-card" style="padding:0;">
  <div class="public-story-wrap">
    <div class="public-story-grid">
      <div class="public-story-left">
        {% if hero_img %}
          <img src="{{ media_url(hero_img) }}"
               alt="Event image">
        {% else %}
          <div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:900;">
            Event Photo
          </div>
        {% endif %}
        <div class="public-story-badge">
          <div class="event-name">{{ event.name }}</div>
        </div>
      </div>

      <div class="public-story-right">
        <h2 class="story-title">{{ qa_title }}</h2>
        <div class="public-story-content">
          {% if qa_published_items and qa_published_items|length > 0 %}
            <div style="display:grid; gap:12px;">
              {% for it in qa_published_items %}
                <div style="border:1px solid var(--border); border-radius:14px; padding:12px; background:rgba(255,255,255,0.02);">
                  <div style="color:var(--accent); font-weight:900;">{{ it.q }}</div>
                  <div style="margin-top:8px; line-height:1.6; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word;">{{ it.a }}</div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="muted" style="font-weight:900;">Nothing here yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% endif %}


<script>
(function(){
  function bind(el){
    if(!el || el.dataset.autogrowBound) return;
    el.dataset.autogrowBound = "1";
    const resize = () => {
      el.style.height = "auto";
      el.style.height = el.scrollHeight + "px";
    };
    el.addEventListener("input", resize);
    setTimeout(resize, 0);
  }
  function bindAll(){
    document.querySelectorAll("textarea.joy-autogrow").forEach(bind);
  }
  bindAll();
  const obs = new MutationObserver(bindAll);
  obs.observe(document.body, {subtree:true, childList:true});
})();
</script>

{% endblock %}
