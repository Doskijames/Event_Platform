{% extends "event_base.html" %}
{% block event_content %}

<!-- ===== Public Single Page (non-admin/non-owner) ===== -->

<!-- Drawer backdrop -->
<div class="joy-drawer-backdrop" id="joyDrawerBackdrop" hidden></div>

<!-- Drawer menu -->
<nav id="joyNavDrawer" class="joy-drawer" aria-label="Sections" hidden>
  <div class="joy-drawer-head">
    <div class="joy-drawer-title">{{ event.name }}</div>
    <button type="button" class="joy-drawer-close" id="joyDrawerClose" aria-label="Close menu">✕</button>
  </div>

  <div class="joy-nav">
    {% for s in public_sections %}
      <a class="joy-nav-link" href="#sec-{{ s.key }}" data-anchor="1">{{ s.title }}</a>
    {% endfor %}
  </div>
</nav>

<div class="joy-single" id="joySingle">

  <!-- LEFT: sticky slideshow -->
  <div class="joy-single-left">
    <!-- hamburger -->
    <button type="button" id="joyBurger" class="joy-burger" aria-label="Open menu" aria-expanded="false">
      ☰
    </button>

    <div class="joy-slideshow">
      <img id="joyImgA" class="joy-slide is-active" src="" alt="Section image">
      <img id="joyImgB" class="joy-slide" src="" alt="Section image">

      <div class="joy-left-overlay">
        <div class="joy-left-title">{{ event.name }}</div>
      </div>
    </div>
  </div>

  <!-- RIGHT: vertical scrolling sections (THIS is the scroller) -->
  <div class="joy-single-right" id="joyScroll">
    {% for s in public_sections %}
      <section
        id="sec-{{ s.key }}"
        class="joy-section"
        data-key="{{ s.key }}"
        data-img="{{ (url_for('static', filename='uploads/' ~ s.image) if s.image else (url_for('static', filename='uploads/' ~ event.cover_image) if event.cover_image else '')) }}"
      >
        <div class="joy-section-inner">

          <h2 class="joy-section-title">{{ s.title }}</h2>

          {# ✅ Mobile-only inline section image (desktop hidden by CSS) #}
          {% set img_src = (url_for('static', filename='uploads/' ~ s.image) if s.image else (url_for('static', filename='uploads/' ~ event.cover_image) if event.cover_image else '')) %}
          {% if img_src %}
            <div class="joy-section-img-mobile">
              <img src="{{ img_src }}" alt="{{ s.title }} image" loading="lazy">
            </div>
          {% endif %}

          {% if s.kind == "home" %}
            <div class="joy-home-inline">
              <h1 class="joy-names" style="margin:6px 0 8px;">{{ event.name }}</h1>
              <p class="joy-message" style="margin:0 0 14px;">We can’t wait to share our special day with you.</p>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px;">
                <a class="joy-cta" href="{{ url_for('event_section', slug=event.slug, section_key='rsvp') }}">RSVP</a>
              </div>

              <div class="joy-date-card" style="margin-top:0;">
                <div class="joy-date-weekday" id="homeWeekday">—</div>
                <div class="joy-date-long" id="homeLongDate">—</div>
                <div class="joy-date-location">{{ event.location }}</div>

                <div class="joy-countdown">
                  <span class="joy-countdown-value" id="homeCdDays">--</span> DAYS
                  <span class="joy-countdown-value" id="homeCdHrs">--</span> HRS
                  <span class="joy-countdown-value" id="homeCdMins">--</span> MINS
                </div>

                <a class="joy-unlock" href="{{ url_for('event_section', slug=event.slug, section_key='rsvp') }}">RSVP</a>
              </div>

              {% if event.description %}
                <p style="margin-top:16px; line-height:1.7;">{{ event.description }}</p>
              {% endif %}
            </div>

          {% elif s.kind == "qa_list" %}
            {% set qa_items = (s["items"] if (s is mapping and "items" in s) else []) %}
            {% if qa_items %}
              <div class="joy-qa-list">
                {% for it in qa_items %}
                  <div class="joy-qa-card">
                    <div class="joy-qa-q">{{ it.q }}</div>
                    <div class="joy-qa-a">{{ it.a }}</div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="muted" style="font-weight:900;">Nothing here yet.</div>
            {% endif %}

          {% elif s.kind == "link" %}
            {% if s.key == "rsvp" %}
              <a class="btn" href="{{ url_for('rsvp_form', slug=event.slug) }}">Open RSVP</a>
            {% elif s.key == "photos" %}
              <a class="btn" href="{{ url_for('event_photos', slug=event.slug) }}">Open Photos</a>
            {% else %}
              <div class="muted" style="font-weight:900;">Open section</div>
            {% endif %}

          {% else %}
            {% if s.html and (s.html|trim) %}
              <div class="ql-editor story-public joy-html">
                {{ s.html|safe }}
              </div>
            {% else %}
              <div class="muted" style="font-weight:900;">Nothing here yet.</div>
            {% endif %}
          {% endif %}

        </div>
      </section>
    {% endfor %}
  </div>
</div>

<!-- ===== Slideshow logic: updates image based on RIGHT pane scroll ===== -->
<script>
(function(){
  const scroll = document.getElementById("joyScroll");
  const imgA = document.getElementById("joyImgA");
  const imgB = document.getElementById("joyImgB");
  if(!scroll || !imgA || !imgB) return;

  const sections = Array.from(scroll.querySelectorAll(".joy-section"));
  let activeKey = null;
  let showingA = true;

  function swapImage(src){
    const s = (src || "").trim();
    if(!s) return;

    const incoming = showingA ? imgB : imgA;
    const outgoing = showingA ? imgA : imgB;

    incoming.src = s;

    const finish = () => {
      incoming.classList.add("is-active");
      outgoing.classList.remove("is-active");
      showingA = !showingA;
    };

    incoming.onload = finish;
    if(incoming.complete) finish();
  }

  function initImage(){
    const first = sections.find(s => (s.dataset.img || "").trim());
    if(!first) return;

    const src = (first.dataset.img || "").trim();
    if(src){
      imgA.src = src;
      imgA.classList.add("is-active");
      imgB.classList.remove("is-active");
      showingA = true;
      activeKey = first.dataset.key || null;
    }
  }

  // ✅ root MUST be the right scroll container (THIS WAS YOUR MAIN ISSUE)
  const obs = new IntersectionObserver((entries)=>{
    const visible = entries
      .filter(e => e.isIntersecting)
      .sort((x,y)=> (y.intersectionRatio - x.intersectionRatio))[0];

    if(!visible) return;

    const key = visible.target.dataset.key;
    if(key && key !== activeKey){
      activeKey = key;
      const src = (visible.target.dataset.img || "").trim();
      if(src) swapImage(src);
    }
  }, { root: scroll, threshold: [0.45, 0.65, 0.85] });

  sections.forEach(s => obs.observe(s));
  initImage();

  // ✅ Smooth scroll inside the right pane (NOT window)
  function scrollToAnchor(hash){
    if(!hash || !hash.startsWith("#sec-")) return;
    const el = scroll.querySelector(hash);
    if(!el) return;
    scroll.scrollTo({ top: el.offsetTop, behavior: "smooth" });
  }

  document.addEventListener("click", (e)=>{
    const a = e.target.closest('a[data-anchor="1"]');
    if(!a) return;
    const href = a.getAttribute("href") || "";
    if(href.startsWith("#sec-")){
      e.preventDefault();
      scrollToAnchor(href);
    }
  });
})();
</script>

<!-- ===== Home date + countdown ===== -->
<script>
(function(){
  const iso = "{{ event.date_iso }}";
  if(!iso) return;

  try{
    const d = new Date(iso + "T00:00:00");
    const weekday = new Intl.DateTimeFormat(undefined, { weekday: "long" }).format(d);
    const longDate = new Intl.DateTimeFormat(undefined, { month:"long", day:"2-digit", year:"numeric" }).format(d);

    const wEl = document.getElementById("homeWeekday");
    const lEl = document.getElementById("homeLongDate");
    if(wEl) wEl.textContent = weekday;
    if(lEl) lEl.textContent = longDate;

    const target = d.getTime();
    const elDays = document.getElementById("homeCdDays");
    const elHrs  = document.getElementById("homeCdHrs");
    const elMins = document.getElementById("homeCdMins");

    function tick(){
      const now = Date.now();
      let diff = target - now;
      if(diff < 0) diff = 0;
      const minsTotal = Math.floor(diff / 60000);
      const days = Math.floor(minsTotal / (60 * 24));
      const hrs  = Math.floor((minsTotal % (60 * 24)) / 60);
      const mins = minsTotal % 60;

      if(elDays) elDays.textContent = String(days);
      if(elHrs)  elHrs.textContent  = String(hrs).padStart(2,"0");
      if(elMins) elMins.textContent = String(mins).padStart(2,"0");
    }

    tick();
    setInterval(tick, 30000);
  } catch(e){}
})();
</script>

<!-- ===== Drawer open/close ===== -->
<script>
(function(){
  const burger = document.getElementById("joyBurger");
  const drawer = document.getElementById("joyNavDrawer");
  const backdrop = document.getElementById("joyDrawerBackdrop");
  const closeBtn = document.getElementById("joyDrawerClose");
  if(!burger || !drawer || !backdrop || !closeBtn) return;

  function openDrawer(){
    drawer.hidden = false;
    backdrop.hidden = false;
    burger.setAttribute("aria-expanded","true");
  }
  function closeDrawer(){
    drawer.hidden = true;
    backdrop.hidden = true;
    burger.setAttribute("aria-expanded","false");
  }

  burger.addEventListener("click", openDrawer);
  closeBtn.addEventListener("click", closeDrawer);
  backdrop.addEventListener("click", closeDrawer);
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeDrawer(); });
  drawer.querySelectorAll("a").forEach(a => a.addEventListener("click", closeDrawer));
})();
</script>

{% endblock %}
