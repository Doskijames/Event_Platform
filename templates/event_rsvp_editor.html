{% extends "event_base.html" %}
{% block event_content %}

<div style="display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; align-items:start;">

  <!-- LEFT: Builder -->
  <div class="section-card">
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div>
        <h2 class="accent" style="margin:0;">RSVP Builder</h2>
        <p class="muted" style="margin:6px 0 0;">
          Build custom RSVP questions (like “Meal choice”, “Plus one name”, etc). Guests see it only after <strong>Save</strong>.
        </p>
      </div>

      {% if is_admin %}
      <form method="POST" action="{{ url_for('rsvp_publish', slug=event.slug) }}">
        <button class="btn" type="submit">Save</button>
      </form>
      {% endif %}
    </div>

    {% if is_admin %}
      <div class="admin-box" style="margin-top:14px;">
        <button class="btn btn-outline" type="button" id="addRowBtn">+ Add RSVP Question</button>
      </div>

      <div id="rowsWrap" style="margin-top:14px; display:grid; gap:12px;"></div>

      <div class="admin-box" style="margin-top:14px;">
        <form method="POST" action="{{ url_for('toggle_section', slug=event.slug, section_key=section_key) }}">
          <button class="btn btn-outline" type="submit">
            {% if section.visible %}Hide RSVP{% else %}Show RSVP{% endif %}
          </button>
        </form>
      </div>

      <p class="muted" id="autosaveStatus" style="margin:12px 2px 0; font-weight:900;"></p>
    {% else %}
      <div class="muted" style="margin-top:14px;">
        RSVP questions are managed by the event owner.
      </div>
    {% endif %}
  </div>

  <!-- RIGHT: Preview -->
  <div class="section-card">
    <div class="muted" style="font-weight:900;">Guest RSVP Preview</div>

    <div style="margin-top:14px;">
      <div class="panel" style="padding:18px;">
        <h3 style="margin:0 0 12px; color:var(--accent);">RSVP</h3>

        <div class="form">
          <label class="label">Full name</label>
          <input class="input" type="text" placeholder="Your name">

          <label class="label">Email</label>
          <input class="input" type="email" placeholder="you@example.com">

          <label class="label">Will you attend?</label>
          <select class="input">
            <option>Yes</option>
            <option>No</option>
            <option>Maybe</option>
          </select>

          <div id="previewWrap" style="display:grid; gap:12px; margin-top:8px;"></div>

          <div class="actions-row">
            <button class="btn" type="button">Submit RSVP</button>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

{% if is_admin %}
<script>
(function(){
  const initial = {{ (draft_items if draft_items else published_items)|tojson }};
  const rowsWrap = document.getElementById("rowsWrap");
  const previewWrap = document.getElementById("previewWrap");
  const addBtn = document.getElementById("addRowBtn");
  const statusEl = document.getElementById("autosaveStatus");

  // item schema:
  // { key: "meal_choice", label:"Meal preference", type:"text|textarea|select", options:[".."] }
  let rows = Array.isArray(initial) ? initial : [];
  if (rows.length === 0){
    rows = [{ key:"meal_preference", label:"Meal preference", type:"text", options:[] }];
  }

  function setStatus(t){ statusEl.textContent = t || ""; }

  function safeKey(str){
    return String(str || "")
      .toLowerCase()
      .replaceAll(/[^a-z0-9]+/g, "_")
      .replaceAll(/^_+|_+$/g, "");
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function render(){
    // Builder rows
    rowsWrap.innerHTML = "";
    rows.forEach((r, idx) => {
      const card = document.createElement("div");
      card.className = "admin-box";

      const opts = Array.isArray(r.options) ? r.options.join("\n") : "";

      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
          <div class="muted" style="font-weight:900;">Question ${idx+1}</div>
          <button type="button" class="btn btn-outline" data-del="${idx}">Delete</button>
        </div>

        <div style="margin-top:10px; display:grid; gap:10px;">
          <div>
            <div class="label">Label (what guest sees)</div>
            <input class="input" type="text" value="${escapeHtml(r.label || "")}" data-label="${idx}">
          </div>

          <div>
            <div class="label">Key (internal id)</div>
            <input class="input" type="text" value="${escapeHtml(r.key || "")}" data-key="${idx}">
            <div class="muted" style="margin-top:6px;">Use lowercase and underscores, e.g. <b>meal_preference</b>.</div>
          </div>

          <div>
            <div class="label">Type</div>
            <select class="input" data-type="${idx}">
              <option value="text" ${r.type==="text"?"selected":""}>Text</option>
              <option value="textarea" ${r.type==="textarea"?"selected":""}>Long text</option>
              <option value="select" ${r.type==="select"?"selected":""}>Dropdown (select)</option>
            </select>
          </div>

          <div style="${r.type==="select" ? "" : "display:none;"}" data-optswrap="${idx}">
            <div class="label">Dropdown options (one per line)</div>
            <textarea class="input textarea" rows="5" data-opts="${idx}">${escapeHtml(opts)}</textarea>
          </div>
        </div>
      `;
      rowsWrap.appendChild(card);
    });

    // Preview
    previewWrap.innerHTML = "";
    rows.forEach((r) => {
      const label = escapeHtml(r.label || "");
      const type = r.type || "text";
      const options = Array.isArray(r.options) ? r.options : [];

      const wrap = document.createElement("div");

      if (type === "textarea"){
        wrap.innerHTML = `
          <label class="label">${label}</label>
          <textarea class="input textarea" rows="4" placeholder=""></textarea>
        `;
      } else if (type === "select"){
        const optsHtml = options.map(o=>`<option>${escapeHtml(o)}</option>`).join("");
        wrap.innerHTML = `
          <label class="label">${label}</label>
          <select class="input">${optsHtml || "<option>Option</option>"}</select>
        `;
      } else {
        wrap.innerHTML = `
          <label class="label">${label}</label>
          <input class="input" type="text" placeholder="">
        `;
      }

      previewWrap.appendChild(wrap);
    });
  }

  let timer = null;
  let lastSent = "";
  let inflight = false;

  async function saveDraft(){
    const payload = JSON.stringify(rows);
    if (payload === lastSent) return;
    if (inflight) return;

    inflight = true;
    setStatus("Saving draft...");
    try{
      const resp = await fetch("{{ url_for('rsvp_save_draft', slug=event.slug) }}", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: payload
      });
      if (resp.ok){
        lastSent = payload;
        setStatus("Draft saved.");
      } else {
        setStatus("Draft save failed.");
      }
    }catch(e){
      setStatus("Draft save failed.");
    }finally{
      inflight = false;
    }
  }

  function scheduleSave(){
    if (timer) clearTimeout(timer);
    timer = setTimeout(saveDraft, 650);
  }

  addBtn.addEventListener("click", ()=>{
    rows.push({ key:"", label:"", type:"text", options:[] });
    render();
    scheduleSave();
  });

  rowsWrap.addEventListener("click", (e)=>{
    const del = e.target.getAttribute("data-del");
    if (del !== null){
      const i = parseInt(del, 10);
      rows.splice(i, 1);
      if (rows.length === 0) rows.push({ key:"", label:"", type:"text", options:[] });
      render();
      scheduleSave();
    }
  });

  rowsWrap.addEventListener("input", (e)=>{
    const idxLabel = e.target.getAttribute("data-label");
    const idxKey = e.target.getAttribute("data-key");
    const idxOpts = e.target.getAttribute("data-opts");

    if (idxLabel !== null){
      const i = parseInt(idxLabel,10);
      rows[i].label = e.target.value;
      if (!rows[i].key) rows[i].key = safeKey(rows[i].label);
      render();
      scheduleSave();
    }
    if (idxKey !== null){
      const i = parseInt(idxKey,10);
      rows[i].key = safeKey(e.target.value);
      render();
      scheduleSave();
    }
    if (idxOpts !== null){
      const i = parseInt(idxOpts,10);
      const raw = e.target.value || "";
      rows[i].options = raw.split("\n").map(s=>s.trim()).filter(Boolean);
      render();
      scheduleSave();
    }
  });

  rowsWrap.addEventListener("change", (e)=>{
    const idxType = e.target.getAttribute("data-type");
    if (idxType !== null){
      const i = parseInt(idxType,10);
      rows[i].type = e.target.value;
      if (rows[i].type !== "select") rows[i].options = [];
      render();
      scheduleSave();
    }
  });

  render();
})();
</script>
{% endif %}

{% endblock %}
