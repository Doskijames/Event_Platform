{% extends "event_base.html" %}
{% block event_content %}

{% if is_admin %}

{# ✅ Removed Open Public Preview button (you said there's an overall preview button already) #}

<div class="admin-editor-grid">


  <!-- LEFT: Editor -->
  <div class="section-card">

    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div>
        <h2 class="accent" style="margin:0;">{{ qa_title }}</h2>
        <p class="muted" style="margin:6px 0 0;">
          Add questions and answers. Preview updates instantly.
          Guests only see it after you click <strong>Save</strong>.
        </p>
      </div>

      <form id="publishForm" method="POST" action="{{ url_for('qa_publish', slug=event.slug) }}">
        <input type="hidden" name="draft_json" id="publishDraftJson" value="">
        <button class="btn" type="submit">Save</button>
      </form>
    </div>

    <div class="admin-box" style="margin-top:14px;">
      <form method="POST" enctype="multipart/form-data"
            action="{{ url_for('upload_section_image', slug=event.slug, section_key=section_key) }}">
        <div class="admin-row">
          <label class="mini-label">{{ qa_title }} Photo</label>
          <input class="mini-file" type="file" name="image" required>
          <button class="btn mini-btn" type="submit">Upload</button>
        </div>
      </form>
      <p class="muted" style="margin:10px 2px 0; font-weight:900;">
        Uploading again replaces the previous photo.
      </p>
    </div>

    <!-- List editor -->
    <div class="admin-box" style="margin-top:14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <div class="mini-label">Items</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn btn-outline" type="button" id="addItemBtn">+ Add</button>
          <button class="btn btn-outline" type="button" id="saveDraftNowBtn">Save Draft Now</button>
        </div>
      </div>

      <div id="itemsWrap" style="margin-top:12px; display:grid; gap:12px;"></div>

      <input type="hidden" id="draftJsonField" value='{{ qa_draft_items|tojson }}'>

      <script>
      (function(){
        const form = document.getElementById("publishForm");
        if(!form) return;
        form.addEventListener("submit", ()=>{
          const draftField = document.getElementById("draftJsonField");
          const publishField = document.getElementById("publishDraftJson");
          if(draftField && publishField){
            publishField.value = draftField.value || "[]";
          }
        });
      })();
      </script>

    </div>

    <div class="admin-box" style="margin-top:14px;">
      <form method="POST" action="{{ url_for('toggle_section', slug=event.slug, section_key=section_key) }}">
        <button class="btn btn-outline" type="submit">
          {% if section.visible %}Hide {{ qa_title }}{% else %}Show {{ qa_title }}{% endif %}
        </button>
      </form>
    </div>

    <p class="muted" id="autosaveStatus" style="margin:12px 2px 0; font-weight:900;"></p>
    <script type="application/json" id="publishedJson">{{ qa_published_items|tojson }}</script>

  </div>

  <!-- RIGHT: Preview -->
  <div class="section-card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div class="muted" style="font-weight:900;">Preview</div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-outline" type="button" id="btnDesk">Desktop</button>
        <button class="btn btn-outline" type="button" id="btnPhone">Phone</button>
      </div>
    </div>

    <div style="margin-top:14px;">
      <div id="previewDesk" style="display:block;">
        <div style="border:1px solid var(--border); border-radius:18px; overflow:hidden; background:rgba(255,255,255,0.02);">
          <div style="display:grid; grid-template-columns: minmax(140px,1fr) minmax(0,4fr); min-height:420px;">

            <div style="background:#0b0b0b; position:relative;">
              {% if section.image %}
                <img src="{{ media_url(section.image) }}"
                     alt="{{ qa_title }} preview"
                     style="width:100%; height:100%; object-fit:cover; display:block;">
              {% else %}
                <div style="height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:900;">
                  Upload {{ qa_title }} Photo
                </div>
              {% endif %}

              {# ✅ Use the universal overlay (your CSS handles glass fade + orange serif) #}
              <div class="event-name-overlay">{{ event.name }}</div>
            </div>

            <div style="padding:18px; max-height:420px; overflow:auto;">
              <h3 style="margin:0 0 12px; color:var(--accent);">{{ qa_title }}</h3>
              <div id="previewContentDesk" style="display:grid; gap:12px;"></div>
            </div>

          </div>
        </div>
      </div>

      <div id="previewPhone" style="display:none;">
        <div style="max-width:360px; margin:0 auto; border:1px solid var(--border); border-radius:24px; overflow:hidden;">
          <div style="background:#0b0b0b; position:relative;">
            {% if section.image %}
              <img src="{{ media_url(section.image) }}"
                   alt="{{ qa_title }} phone preview"
                   style="width:100%; height:260px; object-fit:cover; display:block;">
            {% else %}
              <div style="height:260px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:900;">
                Upload {{ qa_title }} Photo
              </div>
            {% endif %}

            {# ✅ Use the universal overlay #}
            <div class="event-name-overlay">{{ event.name }}</div>
          </div>

          <div style="padding:16px; background:rgba(255,255,255,0.02); max-height:420px; overflow:auto;">
            <h3 style="margin:0 0 12px; color:var(--accent);">{{ qa_title }}</h3>
            <div id="previewContentPhone" style="display:grid; gap:12px;"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
(function(){
  const btnDesk = document.getElementById("btnDesk");
  const btnPhone = document.getElementById("btnPhone");
  const prevDeskWrap = document.getElementById("previewDesk");
  const prevPhoneWrap = document.getElementById("previewPhone");

  btnDesk.addEventListener("click", ()=>{
    prevDeskWrap.style.display = "block";
    prevPhoneWrap.style.display = "none";
  });
  btnPhone.addEventListener("click", ()=>{
    prevDeskWrap.style.display = "none";
    prevPhoneWrap.style.display = "block";
  });
})();
</script>

<script>
(function(){
  const wrap = document.getElementById("itemsWrap");
  const addBtn = document.getElementById("addItemBtn");
  const saveNowBtn = document.getElementById("saveDraftNowBtn");
  const statusEl = document.getElementById("autosaveStatus");
  const draftField = document.getElementById("draftJsonField");

  const pubField = document.getElementById("publishDraftJson");
  const saveUrl = "{{ url_for('qa_save_draft', slug=event.slug) }}";

  function setStatus(msg){ statusEl.textContent = msg || ""; }

  function safeParse(jsonStr){
    try {
      const v = JSON.parse(jsonStr || "[]");
      return Array.isArray(v) ? v : [];
    } catch(e) { return []; }
  }

  function normalize(items){
    return (items || []).map(it => {
      if(!it || typeof it !== "object") return { q:"", a:"" };
      const q = (it.q ?? it.question ?? "").toString();
      const a = (it.a ?? it.answer ?? "").toString();
      return { q, a };
    });
  }

  let items = normalize(safeParse(draftField.value));
  const published = normalize(safeParse(document.getElementById("publishedJson").textContent));
  if (!items.length && published.length) items = published;

  let lastSent = "";
  let dirty = false;
  let timer = null;
  let inflight = false;

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function itemRow(it, idx){
    const row = document.createElement("div");
    row.className = "rsvp-item";
    row.style.background = "rgba(255,255,255,0.02)";
    row.style.borderRadius = "14px";

    row.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
        <div class="mini-label">Item ${idx+1}</div>
        <button type="button" class="btn btn-outline" data-action="remove">Remove</button>
      </div>
      <div style="display:grid; gap:10px; margin-top:10px;">
        <div>
          <div class="label" style="font-size:.9rem;">Question</div>
          <input class="input" type="text" data-field="q" value="${escapeHtml((it.q||"").replace(/^\s*Q:\s*/i,""))}" placeholder="Enter question">
        </div>
        <div>
          <div class="label" style="font-size:.9rem;">Answer</div>
          <textarea class="input textarea joy-autogrow" data-field="a" placeholder="Enter answer" style="width:100%;" rows="6">${escapeHtml((it.a||"").replace(/^\s*A:\s*/i,""))}</textarea>
        </div>
      </div>
    `;

    row.querySelector('[data-action="remove"]').addEventListener("click", ()=>{
      items.splice(idx, 1);
      render();
      scheduleSave();
    });

    row.querySelectorAll("[data-field]").forEach(el => {
      el.addEventListener("input", ()=>{
        const f = el.getAttribute("data-field");
        items[idx][f] = el.value;
        dirty = true;
        renderPreview();
        scheduleSave();
      });
    });

    return row;
  }

  function render(){
    wrap.innerHTML = "";
    if (!items.length) {
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.style.fontWeight = "900";
      empty.textContent = "No items yet. Click Add to create one.";
      wrap.appendChild(empty);
    } else {
      items.forEach((it, idx) => wrap.appendChild(itemRow(it, idx)));
    }
    renderPreview();
  }

  function renderPreview(){
    const desk = document.getElementById("previewContentDesk");
    const phone = document.getElementById("previewContentPhone");
    const filtered = normalize(items).filter(it => (it.q.trim() || it.a.trim()));
    const html = filtered.map(it => `
      <div style="border:1px solid var(--border); border-radius:14px; padding:12px; background:rgba(255,255,255,0.02);">
        <div style="color:var(--accent); font-weight:900;">${escapeHtml((it.q||"").replace(/^\s*Q:\s*/i,""))}</div>
        <div style="margin-top:8px; color:var(--text); line-height:1.6; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word;">${escapeHtml((it.a||"").replace(/^\s*A:\s*/i,""))}</div>
      </div>
    `).join("");
    desk.innerHTML = html || '<div class="muted" style="font-weight:900;">No items yet.</div>';
    phone.innerHTML = html || '<div class="muted" style="font-weight:900;">No items yet.</div>';
  }

  function currentPayload(){
    const cleaned = normalize(items).filter(it => (it.q.trim() || it.a.trim()));
    return JSON.stringify(cleaned, null, 0);
  }

  async function sendDraft(payload){
    if (inflight) return;
    inflight = true;
    try {
      setStatus("Saving draft...");
      const resp = await fetch(saveUrl, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ draft_json: payload }).toString(),
        keepalive: true
      });
      setStatus(resp.ok ? "Draft saved." : "Draft save failed.");
      if (resp.ok) dirty = false;
    } catch(e) {
      setStatus("Draft save failed.");
    } finally {
      inflight = false;
    }
  }

  function scheduleSave(){
    if (timer) clearTimeout(timer);
    timer = setTimeout(()=>{
      const payload = currentPayload();
      if (payload !== lastSent) {
        lastSent = payload;
        draftField.value = payload;
        if (pubField) pubField.value = payload;
        dirty = true;
        sendDraft(payload);
      }
    }, 650);
  }

  window.addEventListener("beforeunload", ()=>{
    try {
      if (!dirty) return;
      const payload = currentPayload();
      if (!payload) return;
      const fd = new FormData();
      fd.append("draft_json", payload);
      navigator.sendBeacon(saveUrl, fd);
    } catch(e) {}
  });

  saveNowBtn.addEventListener("click", ()=>{
    const payload = currentPayload();
    lastSent = payload;
    draftField.value = payload;
    dirty = true;
    sendDraft(payload);
  });

  addBtn.addEventListener("click", ()=>{
    items.push({ q:"", a:"" });
    dirty = true;
    render();
    scheduleSave();
  });

  const publishForm = document.getElementById("publishForm");
  if (publishForm) {
    publishForm.addEventListener("submit", () => {
      const cleaned = normalize(items).filter(it => (it.q.trim() || it.a.trim()));
      const payload = JSON.stringify(cleaned, null, 0);
      if (pubField) pubField.value = payload;
    });
  }

  render();
  setStatus("");
})();
</script>

{% else %}

<div style="max-width:1100px; margin:0 auto; padding: 12px 14px 28px;">
  {# ✅ Removed Back to Editor button as requested #}

  <div style="display:grid; grid-template-columns: 1fr; gap:16px;">
    <div style="display:grid; grid-template-columns: 1fr; gap:16px;" class="twoPanelWrap">
      <div style="border-radius:18px; overflow:hidden; background:rgba(255,255,255,0.06); min-height:260px; position:relative;" class="twoPanelLeft">
        {% set img = (section['image'] if section and section['image'] else (event['cover_image'] if event and event['cover_image'] else '')) %}
        {% if img %}
          <img src="{{ url_for('static', filename='uploads/' ~ img) }}"
               alt="{{ qa_title }}" style="width:100%; height:100%; object-fit:cover; display:block;">
        {% else %}
          <div style="height:100%; min-height:260px; display:flex; align-items:center; justify-content:center; opacity:0.8; font-weight:900;">
            No image uploaded yet.
          </div>
        {% endif %}
        <div class="event-name-overlay">{{ event.name }}</div>
      </div>

      <div style="border-radius:18px; background:rgba(255,255,255,0.06); padding:18px 18px; border:1px solid rgba(255,255,255,0.10);">
        <div style="font-size:24px; font-weight:900; margin:2px 0 12px;">{{ qa_title }}</div>

        <div>
          {% for it in qa_published_items %}
            <div style="padding:14px 14px; border-radius:14px; border:1px solid rgba(255,255,255,0.10); background:rgba(0,0,0,0.20); margin-bottom:12px;">
              <div style="color:var(--accent); font-weight:900;">{{ it.q }}</div>
              <div style="margin-top:8px; line-height:1.6; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word; white-space:pre-wrap; overflow-wrap:anywhere; word-break:break-word;">{{ it.a }}</div>
            </div>
          {% endfor %}
          {% if not qa_published_items or qa_published_items|length == 0 %}
            <div class="muted" style="font-weight:900;">Nothing here yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
@media (min-width: 900px) {
  .twoPanelWrap { grid-template-columns: 0.95fr 1.05fr !important; align-items: stretch; }
}
</style>

{% endif %}


<script>
(function(){
  function bind(el){
    if(!el || el.dataset.autogrowBound) return;
    el.dataset.autogrowBound = "1";
    const resize = () => {
      el.style.height = "auto";
      el.style.height = el.scrollHeight + "px";
    };
    el.addEventListener("input", resize);
    setTimeout(resize, 0);
  }
  function bindAll(){
    document.querySelectorAll("textarea.joy-autogrow").forEach(bind);
  }
  bindAll();
  const obs = new MutationObserver(bindAll);
  obs.observe(document.body, {subtree:true, childList:true});
})();
</script>

{% endblock %}
