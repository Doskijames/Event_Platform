{# templates/_media.html #}
{% macro media_url(v) -%}
  {%- set s = (v or '') | string -%}
  {%- set s = s.strip() -%}
  {%- if not s -%}
    {{ '' }}
  {%- elif s.startswith('gdrive:') -%}
    {{ url_for('drive_media', file_id=s.split('gdrive:', 1)[1]) }}
  {%- elif 'id=' in s -%}
    {%- set fid = s.split('id=', 1)[1].split('&', 1)[0] -%}
    {{ url_for('drive_media', file_id=fid) }}
  {%- elif '/d/' in s -%}
    {%- set fid = s.split('/d/', 1)[1].split('/', 1)[0] -%}
    {{ url_for('drive_media', file_id=fid) }}
  {%- elif s.startswith('http://') or s.startswith('https://') -%}
    {{ s }}
  {%- else -%}
    {{ url_for('static', filename='uploads/' ~ s) }}
  {%- endif -%}
{%- endmacro %}
