{# templates/_media.html #}
{# Single source of truth for turning DB "image" values into a usable <img src> URL. #}

{% macro media_url(value) -%}
  {%- set v = (value or '')|trim -%}
  {%- if not v -%}
    {{ '' }}
  {%- elif v.startswith('http://') or v.startswith('https://') -%}
    {# If it's a Drive URL with an id, route through our proxy endpoint #}
    {%- set file_id = '' -%}
    {%- if 'id=' in v -%}
      {%- set file_id = v.split('id=')[1].split('&')[0] -%}
    {%- elif '/d/' in v -%}
      {%- set file_id = v.split('/d/')[1].split('/')[0] -%}
    {%- endif -%}

    {%- if file_id -%}
      {{ url_for('media_drive', file_id=file_id) }}
    {%- else -%}
      {{ v }}
    {%- endif -%}
  {%- else -%}
    {# A bare filename: serve via /media/<filename> which falls back to Drive if needed #}
    {{ url_for('media_by_name', filename=v) }}
  {%- endif -%}
{%- endmacro %}
