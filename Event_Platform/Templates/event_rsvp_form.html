{% extends "event_base.html" %}
{% block event_content %}

<div class="section-card">
  <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
    <div>
      <h2 class="accent" style="margin:0;">RSVP</h2>
      <p class="muted" style="margin:6px 0 0;">
        Please complete the form below. Some questions will appear based on your answers.
      </p>
    </div>

    {% if is_admin %}
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn btn-outline" href="{{ url_for('rsvp_questions', slug=event.slug) }}">Edit RSVP Questions</a>
      </div>
    {% endif %}
  </div>

  <form method="POST" style="margin-top:16px;" id="rsvpForm" novalidate>

    <!-- used to enforce “confirm on whatsapp before submit” when opted-in -->
    <input type="hidden" id="wa_confirmed" name="whatsapp_confirmed" value="0">

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:14px;">
      <div>
        <label class="label">First Name *</label>
        <input class="input" type="text" name="first_name" required autocomplete="given-name">
      </div>
      <div>
        <label class="label">Last Name *</label>
        <input class="input" type="text" name="last_name" required autocomplete="family-name">
      </div>
    </div>

    <div style="margin-top:12px;">
      <label class="label">Email</label>
      <input class="input" type="email" name="email" value="{{ user.email }}" readonly>
      <p class="muted" style="margin:8px 2px 0; font-size:.9rem;">This is taken from your login.</p>
    </div>

    <div style="margin-top:12px;">
      <label class="label">WhatsApp Number *</label>
      <div style="display:grid; grid-template-columns: 140px 1fr; gap:10px; align-items:center;">
        <select class="input" name="country_code" required>
          <option value="+234">+234 (NG)</option>
          <option value="+1">+1 (US)</option>
          <option value="+44">+44 (UK)</option>
          <option value="+971">+971 (UAE)</option>
          <option value="+233">+233 (GH)</option>
          <option value="+27">+27 (ZA)</option>
        </select>
        <input class="input" type="text"
               name="whatsapp_10"
               inputmode="numeric"
               autocomplete="tel"
               placeholder="10 digits"
               maxlength="10"
               pattern="[0-9]{10}"
               required>
      </div>
      <p class="muted" style="margin:8px 2px 0; font-size:.9rem;">
        Enter exactly 10 digits (excluding country code).
      </p>

      <!-- WhatsApp opt-in (double opt-in) -->
      <div class="admin-box" style="margin-top:12px;">
        <label style="display:flex; gap:10px; align-items:flex-start; cursor:pointer;">
          <input id="wa_opt_in" type="checkbox" name="whatsapp_opt_in" value="1">
          <span>
            <strong>Opt in to WhatsApp updates</strong><br>
            <span class="muted">
              I agree to receive WhatsApp messages from E-accesslink about this event (updates, reminders, and important information).
              You can opt out anytime.
            </span>
          </span>
        </label>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px;">
          <a id="wa_confirm_btn"
             class="btn btn-outline"
             href="{{ url_for('rsvp_whatsapp_confirm', slug=event.slug) }}"
             target="_blank" rel="noopener"
             style="opacity:.55; pointer-events:none;">
            Confirm on WhatsApp
          </a>
          <span class="muted" id="wa_hint">Tick the opt-in box to enable confirmation.</span>
        </div>

        <input type="hidden" name="whatsapp_consent_version" value="v1">
      </div>
    </div>

    {% if questions and questions|length > 0 %}
      <div style="margin-top:18px; display:grid; gap:16px;" id="dynamicQuestions">
        {% for q in questions %}
          <div class="admin-box"
               data-qpos="{{ q.position }}"
               data-show-if-q="{{ q.show_if_question or '' }}"
               data-show-if-values="{{ q.show_if_value or '' }}"
               data-qtype="{{ q.type }}"
               data-multi="{{ 1 if q.get('multi') else 0 }}"
               style="margin:0;">
            <div style="font-weight:900; color:var(--accent);">{{ q.question }}{% if q.required %} *{% endif %}</div>

            <div style="margin-top:10px;">
              {% if q.type == 'text' %}
                <input class="input" type="text" name="q_{{ q.position }}" {% if q.required %}required{% endif %}>
              {% elif q.type == 'number' %}
                <input class="input" type="number" name="q_{{ q.position }}" {% if q.required %}required{% endif %}>
              {% else %}
                {% if q.get('multi') %}
                  <div style="display:grid; gap:8px;">
                    {% for opt in q.options %}
                      <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                        <input type="checkbox" name="q_{{ q.position }}" value="{{ opt }}">
                        <span>{{ opt }}</span>
                      </label>
                    {% endfor %}
                  </div>
                {% else %}
                  <select class="input" name="q_{{ q.position }}" {% if q.required %}required{% endif %}>
                    <option value="">Select...</option>
                    {% for opt in q.options %}
                      <option value="{{ opt }}">{{ opt }}</option>
                    {% endfor %}
                  </select>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted" style="margin-top:18px;">No RSVP questions have been configured yet.</p>
    {% endif %}

    <div class="actions-row" style="margin-top:18px;">
      <button class="btn" id="rsvp_submit_btn" type="submit">Submit RSVP</button>
      <a class="btn btn-outline" href="{{ url_for('event_section', slug=event.slug, section_key='home') }}">Cancel</a>
    </div>

  </form>
</div>

<!-- ✅ Opt-in behavior script: disable submit until confirmed -->
<script>
(function(){
  const cb = document.getElementById("wa_opt_in");
  const confirmBtn = document.getElementById("wa_confirm_btn");
  const hint = document.getElementById("wa_hint");
  const submitBtn = document.getElementById("rsvp_submit_btn");
  const confirmedField = document.getElementById("wa_confirmed");

  // Persist confirmation per event (so user can come back from WhatsApp)
  const key = "wa_confirmed::{{ event.slug }}";

  function setSubmitEnabled(enabled){
    if (!submitBtn) return;
    submitBtn.disabled = !enabled;
    submitBtn.style.opacity = enabled ? "1" : ".55";
    submitBtn.style.cursor = enabled ? "pointer" : "not-allowed";
  }

  function setConfirmEnabled(enabled){
    if (!confirmBtn) return;
    confirmBtn.style.opacity = enabled ? "1" : ".55";
    confirmBtn.style.pointerEvents = enabled ? "auto" : "none";
  }

  function sync(){
    const optedIn = !!(cb && cb.checked);

    if (!optedIn){
      // Not opting in → allow submit, disable confirm button
      localStorage.removeItem(key);
      if (confirmedField) confirmedField.value = "0";
      setSubmitEnabled(true);
      setConfirmEnabled(false);
      if (hint) hint.textContent = "Tick the opt-in box to enable confirmation.";
      return;
    }

    // Opted in → require confirm click before submit
    setConfirmEnabled(true);

    const isConfirmed = localStorage.getItem(key) === "1";
    if (confirmedField) confirmedField.value = isConfirmed ? "1" : "0";

    if (!isConfirmed){
      setSubmitEnabled(false);
      if (hint) hint.textContent = "Please click “Confirm on WhatsApp” before submitting your RSVP.";
    } else {
      setSubmitEnabled(true);
      if (hint) hint.textContent = "Confirmed. You can now submit your RSVP.";
    }
  }

  // When they click Confirm, mark as confirmed and unlock submit
  if (confirmBtn){
    confirmBtn.addEventListener("click", function(){
      localStorage.setItem(key, "1");
      if (confirmedField) confirmedField.value = "1";
      // small delay so UI updates even if it opens a new tab
      setTimeout(sync, 50);
    });
  }

  if (cb){
    cb.addEventListener("change", sync);
  }

  sync();
})();
</script>

<!-- Your existing conditional questions script -->
<script>
(function(){
  const wrap = document.getElementById("dynamicQuestions");
  if (!wrap) return;

  function norm(s){ return String(s || "").trim().toLowerCase(); }

  function condList(raw){
    const s = String(raw || "").trim();
    if (!s) return [];
    return s.split(/[,|]/).map(x => norm(x)).filter(Boolean);
  }

  function getValueFor(pos){
    const el = wrap.querySelector(`[data-qpos="${pos}"]`);
    if (!el) return {multi:false, values:[]};
    const multi = el.getAttribute("data-multi") === "1";
    if (multi){
      const checked = Array.from(el.querySelectorAll(`input[type="checkbox"][name="q_${pos}"]:checked`)).map(x => norm(x.value));
      return {multi:true, values:checked};
    }
    const input = el.querySelector(`[name="q_${pos}"]`);
    const v = input ? norm(input.value) : "";
    return {multi:false, values:[v].filter(Boolean)};
  }

  function clearInputs(box){
    box.querySelectorAll("input, select, textarea").forEach(inp=>{
      if (inp.type === "checkbox" || inp.type === "radio") inp.checked = false;
      else inp.value = "";
    });
  }

  function updateVisibility(){
    const boxes = Array.from(wrap.querySelectorAll("[data-qpos]"));

    boxes.forEach(box=>{
      const showIfQ = box.getAttribute("data-show-if-q");
      const showIfValsRaw = box.getAttribute("data-show-if-values");
      if (!showIfQ){
        box.style.display = "";
        return;
      }

      const parentPos = Number(showIfQ);
      const conds = condList(showIfValsRaw);
      const parent = getValueFor(parentPos).values;

      const isMatch = conds.length === 0
        ? parent.some(v => v)
        : parent.some(v => conds.includes(v));

      if (isMatch){
        box.style.display = "";
      } else {
        box.style.display = "none";
        clearInputs(box);
      }
    });
  }

  wrap.querySelectorAll("input, select, textarea").forEach(el=>{
    el.addEventListener("change", updateVisibility);
    el.addEventListener("input", updateVisibility);
  });

  updateVisibility();
})();
</script>

{% endblock %}
