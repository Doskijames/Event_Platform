{% extends "event_base.html" %}
{% block event_content %}

<div class="section-card">
  <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <div>
      <h2 class="accent" style="margin:0;">RSVP Responses</h2>
      <p class="muted" style="margin:6px 0 0;">Admin/Event owner view</p>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <a class="btn btn-outline" href="{{ url_for('rsvp_responses_export_csv', slug=event.slug) }}">Export CSV</a>
      <a class="btn btn-outline" href="{{ url_for('rsvp_form', slug=event.slug) }}">Back to RSVP</a>
    </div>
  </div>

  <div style="margin-top:14px;">
    {% if responses and responses|length %}
      <div style="overflow-x:auto;">
        <table class="panel" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px;">Submitted</th>
              <th style="text-align:left; padding:10px;">Name</th>
              <th style="text-align:left; padding:10px;">Email</th>
              <th style="text-align:left; padding:10px;">WhatsApp</th>
              <th style="text-align:left; padding:10px;">Opt-in</th>

              {% for q in questions %}
                {% set label = (q.label or q.question or '') %}
                <th style="text-align:left; padding:10px; min-width:220px;">
                  Q{{ loop.index }}<br>
                  <span class="muted">{{ label }}</span>
                </th>
              {% endfor %}
            </tr>
          </thead>

          <tbody>
            {% for item in responses %}
              {% set r = item.row %}
              {% set ans = item.answers %}
              <tr style="border-top:1px solid var(--border);">
                <td style="padding:10px;">{{ r.created_at or '' }}</td>
                <td style="padding:10px;">{{ (r.first_name or '') ~ ' ' ~ (r.last_name or '') }}</td>
                <td style="padding:10px;">{{ r.email or '' }}</td>
                <td style="padding:10px;">{{ r.whatsapp or '' }}</td>
                <td style="padding:10px;">{% if r.whatsapp_opt_in == 1 %}Yes{% else %}No{% endif %}</td>

                {% for q in questions %}
                  {% set key = 'question_' ~ q.position %}
                  {% set a = ans.get(key) %}
                  <td style="padding:10px;">
                    {% if a is iterable and a is not string %}
                      {{ a | join(', ') }}
                    {% else %}
                      {{ a or '' }}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:10px;">Tip: scroll horizontally on mobile to see all questions.</p>
    {% else %}
      <div class="admin-box">
        <p class="muted" style="margin:0;">No RSVP responses yet.</p>
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}
